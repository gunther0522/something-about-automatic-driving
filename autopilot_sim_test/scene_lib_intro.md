# 1. 场景库

## 1.1 概念

**场景**是自动驾驶汽车与其行驶环境各组成要素在一段时间内的总体动态描述，具有无限丰富、极其复杂、难以预测、不可穷尽等特点。

![参考场景](/image/ref_scene.png)

**测试场景**是由车辆自身要素和外部环境要素(静态环境要素、动态环境要素、交通参与者要素、气象要素)的有机组合。

![场景要素](/image/scene_features.png)

**自动驾驶测试场景库**是由满足某种测试需求的一系列自动驾驶测试场景构成的数据库。



## 1.2 测试场景库具备条件

- **真实性**：静态、动态、交通参与者、气象要素可高度还原对应的现实情况
- **交互性**：不同要素之间协调运作以保证测试的真实性和可靠性
- **无限性**：场景参数分布的连续性以及场景元素排列组合的多样性，使得测试场景库不断丰富，最终数量将是无限的
- **扩展性**：明确场景的属性和关系，在此基础上通过改变某一属性可扩展更丰富的测试场景
- **批量化**：借助仿真工具链开发的标准驾驶场景数据接口，能够实现测试用例的批量化导入及建模，并利用高性能仿真服务器实现批量化仿真测试，节约时间成本与人力成本
- **自动化**：测试场景库具备测试评价功能，当仿真测试结束后，结合被测车辆的表现，自动化给出综合评价结果和指标

## 1.3 场景数据来源

来源主要包括三个：`真实采集数据` `模拟数据` `根据真实数据合成的仿真数据`

## 1.3.1 真实采集数据

需要采集车辆自身要素、静态环境要素、动态环境要素、交通参与者要素、气象要素等。

**采集流程：**

① 基于采集的传感器、高精地图等信息根据数据存储标准转化为静态场景数据；
② 基于采集的交通传感器、路况等信息，根据数据存储标准转化为动态场景数据
③ 基于数据标准将静态和动态场景整合位虚拟场景的数据格式，并存储该场景的关键信息，最终形成真实采集场景数据

## 1.3.2 模拟数据

应用软件直接构建高速公路、大型环岛、停车场等虚拟交通环境，在交通环境中使用软件提供现有的模型，模拟机动车、行人、非机动车等交通参与者的交互行为。利用不同交通参与者的行为变化，可以衍生出众多场景以充分测试自动驾驶车辆。

## 1.3.3 根据真实数据合成的仿真数据

真实采集的场景数据经过场景理解、特征提取、场景聚类、场景生成等步骤创建无限的仿真场景数据。

- 场景理解：对采集的图像进行归类
- 特征提取：对场景中的动态、静态元素进行特征提取，然后进行参数化描述
- 场景聚类：对场景进行分类、聚类处理
- 场景生成：对场景参数进行人工编辑，生成新的场景，提高场景覆盖率

## 1.4 场景的自动化生成

由于**自动驾驶测试的场景库还无法覆盖所有场景**，如果单纯采用真实路采数据将耗费大量的时间与成本，因此场景的自动化生成是有必要的。

测试场景要素中车辆自身要素可以提前拟定，环境要素，交通参与者要素，气象要素可以实现自动化生成

**场景要素实现自动化生成**

- 静态环境要素：先通过真实道路采集实现构建，路采数据经构建渲染直接导入场景库
- 动态环境要素&交通参与者：行为逻辑经对抗式生成网络学习后，模拟生成无限的同类要素，例如：转向灯、并线、加减速等驾驶习惯与驾驶行为
- 气象条件：连续变量离散化可以在一定值域空间任意改变，从而变化无限的场景


## 1.5 测试场景构建

自动驾驶系统开发过程主要分为三个阶段，可将场景进行阶段性构建仿真测试，分别为功能场景、逻辑场景、具体场景

举例说明
```
一辆车在双车道快速路弧线段右侧跟随一辆货车行驶
```

**第一阶段——功能场景描述**

```
道路-类型-双车道快速路
道路-路型-弧线
本车-位置-右侧车道
货车-位置-右侧车道
本车-跟随-货车
```
注：融合道路信息、本车信息、交通参与者信息、环境信息，以文字形式将功能场景进行具体描述

**第二阶段——逻辑场景描述**

```
右车道宽度：2.5m~3.75m
左车道宽度：2.5m~3.75m
弧线段半径：300m~900m
本车长：0~100m
货车长：0~100m
货车位置>本车位置
```
注：对功能场景包含信息变量化，并赋予相应的参数值空间范围

**第三阶段——具体场景(或测试用例)描述**

```
右车道宽度：3m
左车道宽度：3m
弧线段半径：500m
本车长：60m
货车长：80m
货车位置>本车位置
```
注：定义场景变量具体的参数值

## 1.6 场景数据格式标准 

场景自动化测试、场景复用是自动驾驶测试大势所趋，哲学要标准场景文件支持，国际通用场景数据格式有OpenDRIVE及OpenSCENARIO,OpenDRIVE实现地图解析，OpenSCENARIO实现场景转换。

OpenDRIVE地图解析工具

- 可将第三方仿真软件生成的地图格式转换为OpenDRIVE标准格式文件
- 基于OpenDRIVE地图格式文件，可实现静态路网快捷编辑功能

OpenSCENARIO场景转换工具

- 基于OpenSCENARIO的动态场景编辑与开发
- 支持基于OpenSCENARIO语言的可编程仿真场景工具可将采集驾驶场景数据自动生成动态场景
- 支持格式转换，可以将其他场景文件与OpenSCENARIO格式文件相互转换

## 1.7 场景库设计流程

![自动驾驶测试场景构建流程](/image/autopilot_test_scene_lib_design_process.png)

自动驾驶测试场景三层结构：`数据层` `场景层` `应用层`

### 1.7.1 数据层

- 负责从开放道路、封闭场地等采集场景构建所需数据，然后自动化处理工具对数据进行特征提取和数字化
- 场景数据可以来自于国家级行业标准法规、交通事故数据库、基础设施数据、气象数据库等
- 进行格式和参数统一后导入场景层

### 1.7.2 场景层

- 负责对采集完成的数据进行处理，例如：场景理解、特征提取等，统一格式后导入场景库
- 需要围绕场景进行聚类、生成、优化处理，从而构成不同场景

### 1.7.3 应用层

- 通过调用场景库中的场景位虚拟场景验证、实车场景验证，确认场景的真实性、代表性、有效性
- 将测试结果反馈给场景库，对场景的分析挖掘方法进行修正，或根据需求重构场景，更新并完善场景库


# 2. 典型场景库



## 2.1 中汽数据-场景案例库


## 2.2 中国典型场景库V2.0

## 2.3 腾讯TAD Sim场景库

## 2.4 百度-Apollo场景库


