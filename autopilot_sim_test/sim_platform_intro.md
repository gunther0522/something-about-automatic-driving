# 引言

# 1. 简介

自动驾驶仿真测试平台的功能需求源于自动驾驶汽车自身的工作原理。当前自动驾驶汽车的普遍技术架构，是通过摄像头、激光雷达、毫米波雷达等传感器识别车辆周围的环境信息，然后由人工智能结合感知信息并依据以往经验做出决策，自主控制转向和速度，使得车辆能够安全可靠的行驶，到达目的地。

## 1.1 功能需求

## 1.1.1 满足全栈算法的闭环仿真测试

自动驾驶核心算法包括**感知算法、决策规划算法、控制算法**三大环节。相应的，自动驾驶仿真测试也应该具有三个算法的仿真测试的能力。
- **感知算法仿真**：需要高还原度的三维重建场景和精准的传感器模型
- **决策规划算法仿真**：需要大量的场景库做支撑
- **控制算法仿真**：需要引入精准的车辆动力学模型

### 1.1.2 满足汽车V字开发流程

V字开发流程是在快速应用开发模型基础上演变而来，包括`功能设计`、`快速控制原型`、`代码集成与测试`、`HIL测试`、`以及实车标定`。
与传统正向开发过程不同，V模型强调软件开发的协作和速度，将软件实现和验证有机结合起来，软件生命周期每一个开发活动都对应一个测试活动，并且两者同时进行，可以保证较高的软件质量情况下缩短开发周期。

### 1.1.3 加速算法迭代升级

目前实际道路测试的规模远不能满足自动驾驶研发测试的需要，仿真测试平台的高效率是其核心功能需求。影响自动驾驶仿真测试效率的两个关键因素。
```
1. 仿真系统是否具备快速自动化生成测试场景的能力
```
这是因为仿真平台的测试场景源于真实的道路采集数据，采集需要耗费大量的时间和成本，如果无法基于真实数据自动化生成场景，逐个采集将会大大降低测试效率。

```
2. 本地调试 + 云端加速仿真
```
在本地将算法调试完毕后，上传到云端快速进行大量的回归测试集验证，将结果返回到本地，分析自动驾驶算法在哪些场景表现良好，哪一类场景表现差，再针对性的做精细调试，推动算法的快速迭代，需要仿真测试平台具备云端并行加速能力。

## 1.2 技术架构

### 1.2.1 仿真场景构建

自动驾驶汽车的仿真测试，首先需要模拟构建与真实世界一致的车辆运行场景。
场景的构建分为`静态场景构建`和`动态场景构`。
常见的场景构建方法是`基于高精度地图及三维重建技术`和`基于增强现实方法构建`。

```
1. 静态场景构建
```

静态场景构建的作用是还原出场景中与车辆行驶相关的静态元素，例如道路，静态交通元素。
- 基于高精度地图及三维重建技术构建场景：
首先需要采集点云、全景图、测绘矢量等非结构化的测绘数据，将测绘数据结构化；
构建厘米级高精度地图(包括：路面、道路标线、交通标识)等信息；
使用三维建模软件建立基础设施与周边环境的可视化数字模型。

```
2. 动态场景构建
```
动态场景元素：动态指示设施、通信环境信息、交通参与者、气象变化、时间变化等。
动态场景在静态场景的基础上复现出场景中动态元素，使得这些元素的动作机器产生的影响严格遵循现实世界的物理规律以及行为逻辑。

## 1.2.2 感知系统仿真

感知系统的仿真分为三个部分：`物理信号仿真`，`原始信号仿真`，`传感器目标仿真`
- 物理信号仿真：直接仿真传感器收到的信号，例如仿真摄像头检测到的光学信号
- 原始信号仿真：把传感器探测的单元拆掉，直接仿真控制电控嵌入式系统中数字处理芯片的输入单元
- 传感器目标仿真：传感器检测的理想目标直接仿真到决策层算法输入端

影响感知系统仿真结果的因素：

- 仿真场景的真实性
- 各类传感器模型，传感器越精确，仿真结果越接近现实

### 1.2.1 摄像头仿真

基于环境物体的几何空间信息构建对象的三维模型，生成逼真的图像。根据物体的真实材质与纹理，通过计算机图形学对三维模型添加颜色与光学属性。

摄像头仿真通过坐标系转换方法，将三维空间点通过透视关系变换为图像上的点，对相机镜头的结构和光学特性，内部数据采集过程进行仿真。

### 2.2.2 毫米波雷达仿真

毫米波雷达仿真会根据配置的视场角和分辨率信息，向不同方向发射一系列虚拟连续调频毫米波，并接收目标的反射信号。
同一个障碍物会被多个调频连续波探测到，对于毫米波雷达目标级仿真，可以根据障碍物的径向距离、距离分辨率和角度分辨率等信息对同一个障碍物的点进行聚类病返回最终仿真结构。
毫米波雷达仿真需要支持更改毫米波雷达安装雷达安装位置、角度、探测距离、探测角度、角度和距离分辨率、噪声等。

### 2.2.3 激光雷达仿真

参照真实激光雷达的扫描方式，模拟每一条真实雷达射线的发射，与场景所有物体求交。
激光雷达反射强度和不同物理材质对激光雷达所使用的近红外光线反射率有关。反射强度受到障碍物距离，激光反射角度以及障碍物本身的物理材质影响。
仿真时需要给场景资源设置合适的物理材质，包括各种道路、人行道、车道线、交通牌、交通灯、汽车、行人等。每一种物理材质的激光反射率都不相同，可以使用仪器测得每一种物理材质的激光反射率。

# 3. 仿真测试平台核心功能

## 3.1 高还原的仿真场景

自动驾驶仿真技术必须尽可能真实还原现实环境，结合自动驾驶汽车工作原理，还原包括：`几何还原`，`物理还原`，`逻辑还原`

### 3.1.1 几何还原

几何还原是指尽可能好的还原出现实世界各种属性都一致的三维场景，根据使用需求的不同还原程度以及使用方式有相应差异。
例如：
1. 需要运行结果比较好的传感器仿真，则需要非常精确的对三维场景进行几何还原，同时有着比较好的传感器仿真模型，才能保证传感器仿真具有高还原度
2. 针对决策控制算法进行仿真测试，那么对于周围环境场景不需要非常精确的进行几何还原，但是需要对路面的道路属性进行比较精确的还原，才能保证汽车控制效果真实性

### 3.1.2 物理还原

重建的三维场景基础上运行自动驾驶控制算法，以及车辆动力学仿真，使得车辆在仿真环境遭受干扰时做出回应、车辆自身行为产生的后果和真实世界保持一致。
例如：
1. 直射的阳光对摄像头造成干扰
2. 雨雪天气延长刹车距离
3. 汽车碰到墙体无法穿越等

### 3.1.3 逻辑还原

生成真实的场景内的各种元素的逻辑行为，交通流车辆、行人、非机动车等所有交通元素遵循在现实世界中的一般运动规律。主要面向决策规划算法的仿真，从逻辑层面为决策规划算法的仿真测试自动生成真实度极高的测试场景。

## 3.2 路采数据生成交互性强和还原性高的交通场景

自动驾驶仿真测试需要大量的路采数据为基础构建场景库。根据路采数据，最简单的方式使用回放式仿真，将采集回来的数据直接回放一遍，评价自动驾驶算法是否顺利通过这些场景。

若是测试场景都需要重新采集数据，会耗费大量的时间和人力成本，因此以更高效的方式利用路采数据，智能化、自动化的生成还原度高、交互性强的交通场景，快速构建场景库，是自动驾驶仿真测试平台的功能要求之一。

## 3.3 云端大规模并行加速

几何、物理、逻辑三个层面的还原以及自动化生成场景的能力，构建了自动驾驶仿真系统的基本属性。但是自动驾驶汽车是由算法在操控，为证明一套算法的完备性，至少需要对数十万测试场景进行回归测试，依靠本地测试逐个运行测试场景不能解决自动驾驶测试效率问题，因此云端高并发运行测试场景是自动驾驶仿真软件的核心竞争力之一。

# 2. 仿真平台介绍

